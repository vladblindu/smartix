# =========================
# 1) BUILD STAGE
# =========================
FROM node:22-alpine AS builder

WORKDIR /app

# Copy only what is needed for dependency install
COPY package.json package-lock.json ./
RUN npm ci

# Copy only build-relevant source & configs
COPY src ./src
COPY static ./static
COPY svelte.config.* vite.config.* tsconfig*.json ./

# Build-time utilities & configs
#COPY __bin ./__bin
#COPY __config ./__config

# Generate dirs.ts from YAML
#RUN npm run gen:dirs

# Build the SvelteKit app
RUN npm run build


# =========================
# 2) RUNTIME STAGE
# =========================
FROM node:22-alpine AS runner

WORKDIR /app
ENV NODE_ENV=production
ENV HOST=0.0.0.0
ENV PORT=3000

# Install only production dependencies
COPY package.json package-lock.json ./
RUN npm ci --omit=dev

# Copy built output only
COPY --from=builder /app/build ./build
COPY --from=builder /app/static ./static

EXPOSE 3000

CMD ["node", "build"]
